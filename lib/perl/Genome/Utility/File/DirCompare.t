#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;

my $pkg = 'Genome::Utility::File::DirCompare';
use_ok($pkg);

my $code_test_dir = __FILE__ . '.d';

my %tests = (
    identical  => {
        test_name  => 'Identical directories',
        diff_count => 0,
    },
    missing    => {
        test_name  => 'Missing file',
        diff_count => 1,
    },
    additional => {
        test_name  => 'Additional file',
        diff_count => 1,
    },
    changed    => {
        test_name  => 'File content changed',
        diff_count => 1,
    },
);

while (my ($subdir, $test_info) = each %tests) {
    subtest $test_info->{test_name} => sub {
        my $original_dir = File::Spec->join($code_test_dir, 'original');
        my $other_dir    = File::Spec->join($code_test_dir, $subdir);
        my @diffs = compare($original_dir, $other_dir);
        is(scalar(@diffs), $test_info->{diff_count}, 'Number of differences as expected');
        if (scalar(@diffs) > 0) {
            like($diffs[0], qr/$test_info->{test_name}/, 'Diff message as expected');
        }
    };
}

sub compare {
    my ($original_dir, $other_dir) = @_;

    my @diffs;
    Genome::Utility::File::DirCompare->compare(
        $original_dir,
        $other_dir,
        sub {
            my ($original_file, $other_file) = @_;
            if (! $original_file) {
                push @diffs, sprintf(
                    'Additional file %s in directory %s',
                    File::Spec->abs2rel($other_file, $other_dir), $other_dir
                );
            } elsif (! $other_file) {
                push @diffs, sprintf(
                    'Missing file %s in directory %s',
                    File::Spec->abs2rel($original_file, $original_dir), $other_dir
                );
            } else {
                push @diffs, sprintf(
                    'File content changed for file %s (diff -u %s %s)',
                    File::Spec->abs2rel($original_file, $original_dir), $original_file, $other_file
                );
            }
        },
    );
    return @diffs;
}

done_testing;
