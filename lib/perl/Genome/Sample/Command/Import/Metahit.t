#!/usr/bin/env genome-perl

use strict;
use warnings;

use above "Genome";
use Test::More;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

UR::DataSource->next_dummy_autogenerated_id;
do {
    $UR::DataSource::last_dummy_autogenerated_id = int($UR::DataSource::last_dummy_autogenerated_id / 10);
} until length($UR::DataSource::last_dummy_autogenerated_id) < 9;
diag('Dummy ID: '.$UR::DataSource::last_dummy_autogenerated_id);
cmp_ok(length($UR::DataSource::last_dummy_autogenerated_id), '<',  9, 'dummy id is shorter than 9 chars');

use_ok('Genome::Sample::Command::Import::Metahit') or die;

my $name = 'MH0000';
my $import = Genome::Sample::Command::Import::Metahit->create(
    name => $name,
    tissue_name => 'G_DNA_Stool',
    gender => 'male',
    age => 99,
    bmi => 22.4,
);
ok($import, 'create');
$import->dump_status_messages(1);
ok($import->execute, 'execute');

my $individual_name = 'METAHIT-'.$name;
is($import->_individual->name, $individual_name, 'individual name');
is($import->_individual->nomenclature, 'METAHIT', 'individual nomenclature');
is($import->_individual->gender, 'male', 'individual gender');
my $sample_name = $individual_name.'-1';
is($import->_sample->name, $sample_name, 'sample name');
is($import->_sample->nomenclature, 'METAHIT', 'sample nomenclature');
is($import->_sample->extraction_label, $sample_name, 'sample extraction label');
is($import->_sample->extraction_type, 'genomic dna', 'sample extraction type');
is($import->_sample->tissue_desc, 'G_DNA_Stool', 'sample tissue');
is($import->_sample->age, 99, 'sample age');
is($import->_sample->body_mass_index, 22.4, 'sample bmi');
is_deeply($import->_sample->source, $import->_individual, 'sample source');
my $library_name = $sample_name.'-extlibs';
is($import->_library->name, $library_name, 'library name');
is_deeply($import->_library->sample, $import->_sample, 'library sample');
is(@{$import->_created_objects}, 3, 'created 3 objects');

done_testing();
exit();

