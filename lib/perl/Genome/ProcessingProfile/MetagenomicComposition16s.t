#!/usr/bin/env genome-perl

use strict;
use warnings;

use above 'Genome';

use Test::More;

BEGIN {
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use_ok('Genome::ProcessingProfile::MetagenomicComposition16s') or die;

my $pp = Genome::ProcessingProfile->create(
    type_name => 'metagenomic composition 16s',
    name => '16S Test Sanger',
    amplicon_processor => 'filter by-min-length --length 1150',
    sequencing_center => 'gsc',
    sequencing_platform => 'sanger',
    assembler => 'phred_phrap',
    assembler_params => '-vector_bound 1000 -trim_qual 1000',
    classifier => 'rdp2-1',
    classifier_params => '-training_set broad',
    chimera_detector => 'chimera-slayer',
    chimera_detector_params => "--nastier-params '-num_top_hits 1000000' --chimera-slayer-params '-windowSize 50 -printCSalignments -windowStep 5'",
);
ok($pp, 'create pp') or die;
isa_ok($pp, 'Genome::ProcessingProfile::MetagenomicComposition16s');

my @amplicon_processor_commands = $pp->amplicon_processor_commands;
is_deeply(
    @amplicon_processor_commands,
    ('gmt sx filter by-min-length --length 1150'),
    'amplicon processor commands'
);

my %assembler_params = $pp->assembler_params_as_hash;
is_deeply(
    \%assembler_params,
    { vector_bound => 1000, trim_qual => 1000 },
    'assembler params as hash'
);

my %classifier_params = $pp->classifier_params_as_hash;
is_deeply(
    \%classifier_params,
    { training_set => 'broad' },
    'classifier params as hash'
);

my @stages = $pp->stages;
is_deeply(\@stages, [qw/ one /], 'Stages');
my @stage_one_classes = $pp->classes_for_stage($stages[0]);
is_deeply(
    \@stage_one_classes, 
    [qw/
    Genome::Model::Event::Build::MetagenomicComposition16s::PrepareInstrumentData
    Genome::Model::Event::Build::MetagenomicComposition16s::DetectAndRemoveChimeras
    Genome::Model::Event::Build::MetagenomicComposition16s::Classify
    Genome::Model::Event::Build::MetagenomicComposition16s::Orient
    Genome::Model::Event::Build::MetagenomicComposition16s::Reports
    /], 
    'Stage one classes'
);

# chimera detector validation fails
$pp->chimera_detector('unknown');
my $rv = $pp->validate_chimera_detector;
ok(!$rv, 'unknown chimera detector fails to validate');
$pp->chimera_detector('chimera-slayer');
$pp->chimera_detector_params('-blah');
$rv = $pp->validate_chimera_detector;
ok(!$rv, 'bad chimera detector params fails to validate');

done_testing();
