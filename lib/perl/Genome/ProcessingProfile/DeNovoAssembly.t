#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_DBI_NO_COMMIT} = 1;
}

use strict;
use warnings;

use above "Genome";

use Test::More;

use_ok('Genome::ProcessingProfile::DeNovoAssembly') or die;

# Create fail - no seq platform
ok(
    !Genome::ProcessingProfile::DeNovoAssembly->create(
        name => 'DNA Test',
        assembler_name => 'velvet one-button',
        assembler_version => '7.0.57-64',
    ),
    'Failed as expected - create w/o seq platform',
);
# Create fail - no assembler
ok(
    !Genome::ProcessingProfile::DeNovoAssembly->create(
        name => 'DNA Test',
        assembler_version => '7.0.57-64',
    ),
    'Failed as expected - create w/o assembler',
);
# Create fail - invalid assembler
ok(
    !Genome::ProcessingProfile::DeNovoAssembly->create(
        name => 'DNA Test',
        assembler_name => 'consed',
        assembler_version => '7.0.57-64',
    ),
    'Failed as expected - create w/ invalid assembler',
);
# Create fail - invalid coverage
ok(
    !Genome::ProcessingProfile::DeNovoAssembly->create(
        name => 'DNA Test',
        assembler_name => 'velvet one-button',
        assembler_version => '7.0.57-64',
        coverage => -1,
    ),
    'Failed as expected - create w/ invalid coverage',
);
# Create fail - invalid assembler/platform combo
ok(
    !Genome::ProcessingProfile::DeNovoAssembly->create(
        name => 'DNA Test',
        assembler_name => 'newbler',
        assembler_version => '7.0.57-64',
    ),
    'Failed as expected - create w/ invalid assembler and seq platform combo',
);
# Create fail - no assembler version
ok(
    !Genome::ProcessingProfile::DeNovoAssembly->create(
        name => 'DNA Test',
        assembler_name => 'velvet one-button',
    ),
    'Failed as expected - create w/o assembler version',
);
# Create fail - invalid assembler params
ok(
    !Genome::ProcessingProfile::DeNovoAssembly->create(
        name => 'DNA Test',
        assembler_name => 'velvet one-button',
        assembler_version => '7.0.57-64',
        assembler_params => '-wrong params',
    ),
    'Failed as expected - create w/ invalid assembler params',
);
# Create fail - calculated assembler params
ok(
    !Genome::ProcessingProfile::DeNovoAssembly->create(
        name => 'DNA Test',
        assembler_name => 'velvet one-button',
        assembler_version => '7.0.57-64',
        assembler_params => '-ins_length 260',
    ),
    'Failed as expected - create w/ calculated assembler params',
);


my @params_and_xml_list = (
    {
        params => { name => 'allpaths test pp', coverage => 50,
            assembler_name => 'allpaths de-novo-assemble',
            assembler_version => 'allpaths test version',
        },
        workflow_xml_template => <<EOS
<?xml version='1.0' standalone='yes'?>
<workflow name="%s all stages" executor="Workflow::Executor::SerialDeferred" logDir="%s">
  <link fromOperation="input connector" fromProperty="instrument_data" toOperation="ProcessInstrumentData" toProperty="instrument_data" />
  <link fromOperation="ProcessInstrumentData" fromProperty="build" toOperation="MergeAndLinkSxResults" toProperty="build" />
  <link fromOperation="MergeAndLinkSxResults" fromProperty="output_build" toOperation="Assemble" toProperty="build" />
  <link fromOperation="MergeAndLinkSxResults" fromProperty="sx_results" toOperation="Assemble" toProperty="sx_results" />
  <link fromOperation="input connector" fromProperty="build" toOperation="ProcessInstrumentData" toProperty="build" />
  <link fromOperation="Assemble" fromProperty="build" toOperation="Report" toProperty="build" />
  <link fromOperation="Report" fromProperty="report_directory" toOperation="output connector" toProperty="report_directory" />
  <operation name="Assemble">
    <operationtype commandClass="Genome::Model::DeNovoAssembly::Build::Assemble" lsfProject="build%s" lsfQueue="alignment-pd" lsfResource="-n 4 -R 'span[hosts=1] select[type==LINUX64 &amp;&amp; mem&gt;61440] rusage[mem=61440]' -M 63963136" typeClass="Workflow::OperationType::Command" />
  </operation>
  <operation name="ProcessInstrumentData" parallelBy="instrument_data">
    <operationtype commandClass="Genome::Model::DeNovoAssembly::Build::ProcessInstrumentData" lsfProject="build%s" lsfQueue="$ENV{GENOME_LSF_QUEUE_BUILD_WORKER_ALT}" lsfResource="-R 'select[type==LINUX64 &amp;&amp; mem&gt;32000 &amp;&amp; gtmp&gt;200] rusage[mem=32000:gtmp=200] span[hosts=1]' -M 32000000" typeClass="Workflow::OperationType::Command" />
  </operation>
  <operation name="MergeAndLinkSxResults">
    <operationtype commandClass="Genome::Model::DeNovoAssembly::Build::MergeAndLinkSxResults" lsfProject="build%s" lsfQueue="$ENV{GENOME_LSF_QUEUE_BUILD_WORKER_ALT}" lsfResource="-R 'select[type==LINUX64 &amp;&amp; gtmp&gt;1000] rusage[gtmp=1000] span[hosts=1]'" typeClass="Workflow::OperationType::Command" />
  </operation>
  <operation name="Report">
    <operationtype commandClass="Genome::Model::DeNovoAssembly::Command::Report" lsfProject="build%s" lsfQueue="$ENV{GENOME_LSF_QUEUE_BUILD_WORKER_ALT}" typeClass="Workflow::OperationType::Command" />
  </operation>
  <operationtype typeClass="Workflow::OperationType::Model">
    <inputproperty>build</inputproperty>
    <inputproperty>instrument_data</inputproperty>
    <outputproperty>report_directory</outputproperty>
  </operationtype>
</workflow>
EOS
    },

    {
        params => { name => 'velvet test pp', coverage => 30,
            assembler_name => 'velvet one-button',
            assembler_version => '1.1.06',
            post_assemble => 'metrics'
        },
        workflow_xml_template => <<EOS
<?xml version='1.0' standalone='yes'?>
<workflow name="%s all stages" executor="Workflow::Executor::SerialDeferred" logDir="%s">
  <link fromOperation="PrepareInstrumentData" fromProperty="build" toOperation="Assemble" toProperty="build" />
  <link fromOperation="input connector" fromProperty="build" toOperation="PrepareInstrumentData" toProperty="build" />
  <link fromOperation="Assemble" fromProperty="build" toOperation="PostAssemble" toProperty="build" />
  <link fromOperation="PostAssemble" fromProperty="build" toOperation="Report" toProperty="build" />
  <link fromOperation="Report" fromProperty="report_directory" toOperation="output connector" toProperty="report_directory" />
  <operation name="Assemble">
    <operationtype commandClass="Genome::Model::DeNovoAssembly::Command::Assemble" lsfProject="build%s" lsfQueue="$ENV{GENOME_LSF_QUEUE_BUILD_WORKER_ALT}" lsfResource="-n 4 -R 'span[hosts=1] select[type==LINUX64 &amp;&amp; mem&gt;30000] rusage[mem=30000]' -M 30000000" typeClass="Workflow::OperationType::Command" />
  </operation>
  <operation name="PrepareInstrumentData">
    <operationtype commandClass="Genome::Model::DeNovoAssembly::Command::PrepareInstrumentData" lsfProject="build%s" lsfQueue="$ENV{GENOME_LSF_QUEUE_BUILD_WORKER_ALT}" lsfResource="-R 'select[type==LINUX64 &amp;&amp; mem&gt;32000 &amp;&amp; gtmp&gt;200] rusage[mem=32000:gtmp=200] span[hosts=1]' -M 32000000" typeClass="Workflow::OperationType::Command" />
  </operation>
  <operation name="Report">
    <operationtype commandClass="Genome::Model::DeNovoAssembly::Command::Report" lsfProject="build%s" lsfQueue="$ENV{GENOME_LSF_QUEUE_BUILD_WORKER_ALT}" typeClass="Workflow::OperationType::Command" />
  </operation>
  <operation name="PostAssemble">
    <operationtype commandClass="Genome::Model::DeNovoAssembly::Command::PostAssemble" lsfProject="build%s" lsfQueue="$ENV{GENOME_LSF_QUEUE_BUILD_WORKER_ALT}" lsfResource="-R 'select[type==LINUX64 &amp;&amp; mem&gt;30000] rusage[mem=30000] span[hosts=1]' -M 30000000" typeClass="Workflow::OperationType::Command" />
  </operation>
  <operationtype typeClass="Workflow::OperationType::Model">
    <inputproperty>build</inputproperty>
    <inputproperty>instrument_data</inputproperty>
    <outputproperty>report_directory</outputproperty>
  </operationtype>
</workflow>
EOS
    }

);

my $tmp_dir = File::Temp::tempdir(
    'ProcessingProfile-DeNovoAssembly-XXXXX',
    TMPDIR => 1,
    CLEANUP => 1,
);

# all this model needs to do is return something for inst data
my %inst_data_params = ( run_name => 'XXXXXX', subset_name => 1 );
my @instrument_data = (
    Genome::InstrumentData::Solexa->__define__(%inst_data_params),
    Genome::InstrumentData::Solexa->__define__(%inst_data_params));

for my $params_and_xml (@params_and_xml_list) {
    my $pp = Genome::ProcessingProfile::DeNovoAssembly->create(
        %{$params_and_xml->{'params'}});

    my $model = Genome::Model::DeNovoAssembly->__define__(
        name => "__TEST_MODEL__%s", , processing_profile => $pp,
        instrument_data => \@instrument_data);
    my $build = Genome::Model::Build::DeNovoAssembly->__define__(
        model => $model, data_directory => $tmp_dir);

    my $workflow = $pp->_resolve_workflow_for_build($build);
    my @validation_results = $workflow->validate;
    ok($workflow->is_valid, sprintf("validated workflow for '%s'",
            $params_and_xml->{'params'}->{'name'}));
    print Data::Dumper::Dumper(\@validation_results) if not $workflow->is_valid;

    my @operations = $workflow->operations;

    my $actual_xml = $workflow->save_to_xml();

    my $expected_xml = sprintf($params_and_xml->{'workflow_xml_template'},
        $build->id, $build->data_directory . '/logs/', $build->id,
        $build->id, $build->id, $build->id);

    my $diff = Genome::Sys->diff_text_vs_text($actual_xml,
        $expected_xml);
        print "Expected: $expected_xml\n";
        print "Actual: $actual_xml\n";
    ok(!$diff, sprintf("workflow xml diffs for '%s'",
            $params_and_xml->{'params'}->{'name'}));
}

done_testing();
