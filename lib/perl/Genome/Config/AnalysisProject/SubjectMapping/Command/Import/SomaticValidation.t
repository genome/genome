#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use Test::Exception;
use Test::More;
use Genome::Test::Factory::Sample;

use above 'Genome';

my $number_of_mappings = 2;
my $class = 'Genome::Config::AnalysisProject::SubjectMapping::Command::Import::SomaticValidation';
use_ok($class);

my $analysis_project = Genome::Config::AnalysisProject->__define__(name => 'test proj');

# success
my $test_file = _test_file();
my $cmd = $class->create(
    analysis_project => $analysis_project,
    file_path => $test_file,
);
isa_ok($cmd, $class);

my $res = $cmd->execute();
ok($res, 'command ran successfully');
is($res, $number_of_mappings,
    "we expected to create $number_of_mappings subject mappings and did");

my @mappings = $analysis_project->subject_mappings;
is(scalar(@mappings), $number_of_mappings,
    'we associated the correct number of pairings with the AnalysisProject');

for my $mapping (@mappings) {
    my @tags = $mapping->tags;
    ok(scalar(@tags), 'tags found assigned to mapping');
}

# fail - same smaple used
throws_ok(sub{
        $class->execute(
            analysis_project => $analysis_project,
            file_path => _test_file_with_same_sample(),
        );
    },
    qr/Same sample given for normal\/tumor: /,
    'failed as expected with normal/tumor flipped',
);

# fail - normal/tumor flipped
throws_ok(sub{
        $class->execute(
            analysis_project => $analysis_project,
            file_path => _test_file_with_normal_tumor_flipped(),
        );
    },
    qr/Incompatible label \(tumor_sample\) for subject/,
    'failed as expected with same sample',
);

done_testing();

sub _test_file {
    my ($fh, $path) = Genome::Sys->create_temp_file();

    for(1..$number_of_mappings) {
        if ($_ % 2 == 0) {
            $fh->printf("%s\t%s\t%s\t%s\t%s\t%s\t%s\n",
                Genome::Test::Factory::Sample->setup_object(common_name => 'xenograft')->id,
                Genome::Test::Factory::Sample->setup_object(common_name => 'normal')->id,
                Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
                Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
                Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
                Genome::Config::Tag->__define__(name => 'test'.$_)->id,
                Genome::Config::Tag->__define__(name => 'second_test'.$_)->name,
            );
        } else {
            $fh->printf("%s\t%s\t%s\t%s\t%s\t%s\n",
                Genome::Test::Factory::Sample->setup_object(common_name => 'xenograft')->name,
                Genome::Test::Factory::Sample->setup_object(common_name => 'normal')->name,
                Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
                Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
                Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
                Genome::Config::Tag->__define__(name => 'test'.$_)->name,
            );
        }
    }

    $fh->close();
    return $path;
}

sub _test_file_with_same_sample{
    my ($fh, $path) = Genome::Sys->create_temp_file();
    my $sample = Genome::Test::Factory::Sample->setup_object(common_name => 'unknown');
    $fh->printf("%s\t%s\t%s\t%s\t%s\t%s\t%s\n",
        $sample->id,
        $sample->id,
        Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
        Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
        Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
        Genome::Config::Tag->__define__(name => 'test1')->id,
    );
    $fh->close();
    return $path;
}

sub _test_file_with_normal_tumor_flipped {
    my ($fh, $path) = Genome::Sys->create_temp_file();
    $fh->printf("%s\t%s\t%s\t%s\t%s\t%s\t%s\n",
        Genome::Test::Factory::Sample->setup_object(common_name => 'normal')->id,
        Genome::Test::Factory::Sample->setup_object(common_name => 'xenograft')->id,
        Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
        Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
        Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
        Genome::Config::Tag->__define__(name => 'test1')->id,
    );
    $fh->close();
    return $path;
}

sub _test_file_with_two_normals {
    my ($fh, $path) = Genome::Sys->create_temp_file();
    $fh->printf("%s\t%s\t%s\t%s\t%s\t%s\t%s\n",
        Genome::Test::Factory::Sample->setup_object(common_name => 'normal')->id,
        Genome::Test::Factory::Sample->setup_object(common_name => 'normal')->id,
        Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
        Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
        Genome::Model::Tools::DetectVariants2::Result::Manual->__define__()->id,
        Genome::Config::Tag->__define__(name => 'test1')->id,
    );
    $fh->close();
    return $path;
}
