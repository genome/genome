#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;
use Genome::Utility::Test qw(compare_ok);
use Sub::Override;

my $pkg = 'Genome::VariantReporting::Reporter::SimpleReporter';
use_ok($pkg);

my $factory = Genome::VariantReporting::Framework::Factory->create();
isa_ok($factory->get_class('reporters', $pkg->name), $pkg);

my $data_dir = __FILE__.".d";

my $reporter = Genome::VariantReporting::Reporter::SimpleReporter->create(file_name => 'simple', generate_legend_file => 0);
ok($reporter, "Reporter created successfully");

my $position_interpreter = Genome::VariantReporting::Generic::PositionInterpreter->create();
my $vep_interpreter = Genome::VariantReporting::Suite::Vep::VepInterpreter->create();
my $variant_type_interpreter= Genome::VariantReporting::Generic::VariantTypeInterpreter->create();
$reporter->add_interpreter_objects($position_interpreter, $vep_interpreter, $variant_type_interpreter);

my $output_dir = Genome::Sys->create_temp_directory();
$reporter->initialize($output_dir);

my %interpretations = (
    'position' => {
        T => {
            chromosome_name => 1,
            start => 1,
            stop => 1,
            reference => 'A',
            variant => 'T',
        },
        G => {
            chromosome_name => 1,
            start => 1,
            stop => 1,
            reference => 'A',
            variant => 'G',
        },
    },
    'vep' => {
        T => {
            transcript_name   => 'ENST00000452176',
            trv_type          => 'DOWNSTREAM',
            amino_acid_change => '',
            default_gene_name => 'RP5-857K21.5',
            ensembl_gene_id   => 'ENSG00000223659',
        },
        G => {
            transcript_name   => 'ENST00000452176',
            trv_type          => 'DOWNSTREAM',
            amino_acid_change => '',
            default_gene_name => 'RP5-857K22.5',
            ensembl_gene_id   => 'ENSG00000223695',
        },
    },
    'variant-type' => {
        T => {
            variant_type => "snv",
        },
        G => {
            variant_type => "snv",
        },
    },
);

$reporter->report(\%interpretations);
$reporter->finalize();

compare_ok(File::Spec->join($output_dir, 'simple'), File::Spec->join($data_dir, "expected.out"), "Output as expected");

done_testing;
