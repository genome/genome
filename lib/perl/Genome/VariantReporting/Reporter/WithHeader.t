#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::Exception;
use Test::More;
use Genome::VariantReporting::Framework::Plan::TestHelpers;

my $pkg = "Genome::VariantReporting::Reporter::WithHeader";
use_ok($pkg);

{
    package Test::BadReporter;

    class Test::BadReporter {
        is => 'Genome::VariantReporting::Reporter::WithHeader',
    };

    sub name {
        "bad_reporter";
    }

    sub required_interpreters {
        return qw(interpreter_y);
    }

    sub headers {
        return qw(different_field);
    }
    1;
}

{
    package Genome::VariantReporting::DuplicateInterpreter;

    class Genome::VariantReporting::DuplicateInterpreter {
        is => 'Genome::VariantReporting::Framework::Component::Interpreter',
    };
    sub name {
        'duplicate';
    }
    sub field_descriptions {
        return (
            chrom => 'Description of chrom',
        );
    }
}

{
    package Test::BadReporter2;

    class Test::BadReporter2 {
        is => 'Genome::VariantReporting::Reporter::WithHeader',
    };

    sub name {
        "bad_reporter2";
    }

    sub required_interpreters {
        return qw(interpreter_y duplicate);
    }

    sub headers {
        return qw(chrom);
    }
    1;
}

my $reporter = Test::BadReporter->__define__(
    filters => {},
    interpreters => {
        interpreter_y => Genome::VariantReporting::AnotherTestInterpreter->create()
    },
);
my @errors = $reporter->__errors__;
is(scalar(@errors), 1, 'Found an error');
ok(($errors[0])->desc =~ /\(different_field\) is not defined/,
    'Error is of correct type');

throws_ok(sub {
    Test::BadReporter2->__define__(
        filters => {},
        interpreters => {
            interpreter_y => Genome::VariantReporting::AnotherTestInterpreter->create(),
            duplicate =>  Genome::VariantReporting::DuplicateInterpreter->create(),
        },
    );
}, qr/Fields are not unique/, "Reporter does not validate");

done_testing;

