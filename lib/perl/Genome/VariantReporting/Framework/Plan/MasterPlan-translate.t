#!/usr/bin/env genome-perl

use strict;
use warnings FATAL => 'all';

use Test::More;
use above 'Genome';
use Genome::Utility::Test qw(compare_ok);
use Test::Exception;
use Test::Output;
use Genome::VariantReporting::Framework::Plan::TestHelpers; # defines classes

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

my $pkg = 'Genome::VariantReporting::Framework::Plan::MasterPlan';
use_ok($pkg) || die;
test_bad_translations('missing_expert_translation', qr(Plan is incompatible with translations file) );
test_bad_translations('missing_interpreter_translation', qr(Plan is incompatible with translations file) );
test_bad_translations('missing_filter_translation', qr(Plan is incompatible with translations file) );

subtest 'translate' => sub {
    my $plan_file = yaml_file("translated_plan.yaml");
    my $plan = $pkg->create_from_file($plan_file);
    ok($plan, "Made a plan from file ($plan_file).");

    throws_ok(sub {$plan->_translate_single('old value', undef, 'attribute')},
        qr(No translations provided), 'translate dies if no translations are provided');
    eval {$plan->_translate_single('old value', undef, 'attribute')};
    ok(Exception::Class->caught('NoTranslationsException'), 'Exception is of correct type')
};

subtest 'translate is many input' => sub {
    my $plan_file = yaml_file("translated_plan.yaml");
    my $plan = $pkg->create_from_file($plan_file);
    ok($plan, "Made a plan from file ($plan_file).");

    my $new_value = [qw(new_value1 new_value2)];
    my $translations = {
        old_value => $new_value,
        old_value1 => 'new_value1',
        old_value2 => 'new_value2',
        tumor => 'tumor1',
        to_translate1 => 'translation1',
        to_translate2 => 'translation2',
        __input__ => 'an_input',
    };
    $plan->translate($translations);
    my $hashref = $plan->as_hashref;
    my $translated_interpreter = $hashref->{reports}->{__translated_test__}->{interpreters}->
            {__translated_test__};

    my $translated_value = $translated_interpreter->{translated2};
    is_deeply($translated_value, $new_value, "Array translation is flattened correctly");

    my $translated_value2 = $translated_interpreter->{translated3};
    is_deeply($translated_value, $new_value, "Individual values are correctly inserted in the array");
};

subtest 'translate HASH input' => sub {
    my $plan_file = yaml_file("plan_with_hash_translations_needed.yaml");
    my $plan = $pkg->create_from_file($plan_file);
    ok($plan, "Made a plan from file ($plan_file).");

    my $translations = {
        foo => 'translated from foo',
        bar => 'baz',
        sample_name_labels => {
            baz => 'qux',
        },
    };
    $plan->translate($translations);
    my ($interpreter_plan) = $plan->get_plan('report', '__test__')->interpreter_plans;
    my $interpreter = $interpreter_plan->object();
    is_deeply(
        [$interpreter->create_sample_specific_field_names(['field_name'])],
        ['translated from foo_field_name', 'qux_field_name'],
        'Translated HASH values working'
    );
};

done_testing();


sub test_bad_translations {
    my $name = shift;
    my $error_regex = shift;

    my $filename = $name . '.yaml';

    my $plan_file = yaml_file("translated_plan.yaml");
    my $translations_file = yaml_file($filename);
    my $plan = $pkg->create_from_file($plan_file);
    ok($plan, sprintf("Made a plan from file ($plan_file)."));
    my $translations_provider = Genome::VariantReporting::Framework::Component::RuntimeTranslations->create_from_file($translations_file);
    ok($translations_provider, sprintf("Made a translations provider from file ($translations_file)."));

    throws_ok sub {$plan->validate_translation_provider($translations_provider);}, $error_regex, "Validation fails for incompatible plan and translations file ($name).";
}

sub yaml_file {
    my $filename = shift;
    return File::Spec->join(__FILE__ . ".d", $filename);
}


