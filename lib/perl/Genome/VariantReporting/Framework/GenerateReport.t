#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;
use File::Basename qw(basename);
use Genome::Utility::Test qw(compare_ok);
use Genome::VariantReporting::Framework::Plan::TestHelpers;

my $pkg = "Genome::VariantReporting::Framework::GenerateReport";

use_ok($pkg);

my $data_dir = __FILE__.".d";
my $vcf_file = File::Spec->join($data_dir, "test.vcf");
my $plan = Genome::VariantReporting::Framework::Plan::MasterPlan->create_from_file(File::Spec->join($data_dir, "test.yaml"));

my $translations = { untranslated => 'translated'};
my $provider = Genome::VariantReporting::Framework::Component::RuntimeTranslations->create(
    translations => $translations,
);

$plan->validate();
$plan->validate_translation_provider($provider);
$plan->translate($provider->translations);

my $generator = $pkg->create(
    input_vcf => $vcf_file,
    plan_json => $plan->as_json,
    variant_type => "snvs",
);
ok($generator->isa($pkg), "Generator created ok");
ok($generator->execute, "Generator executed ok");

my ($epsilon_reporter_object) = grep {$_->isa('Genome::VariantReporting::TestEpsilonReporter')} $generator->output_result->create_reporters();
my $translated_interpreter = $epsilon_reporter_object->interpreters->{interpreter_z};
is($translated_interpreter->iz_p1, 'translated', 'Attached interpreter\'s parameters were translated correctly');

for my $expected_report (glob File::Spec->join($data_dir, "expected", "*")) {
    compare_ok(File::Spec->join($generator->output_result->output_dir, basename($expected_report)), 
                    $expected_report,
                    sprintf("Report %s generated as expected", basename($expected_report)));
}
done_testing;

