#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use above 'Genome';

use Test::More tests => 12;

use_ok('Genome::Model::Command::InstrumentData::List') or die;

class Genome::Model::Tester {
    is => 'Genome::ModelDeprecated',
};
class Genome::ProcessingProfile::Tester {
    is => 'Genome::ProcessingProfile',
};
sub Genome::ProcessingProfile::Tester::sequencing_platform { 'solexa'; }

my $m = Genome::Model::Tester->create(
    name => '__TEST__MODEL__',
    subject => Genome::Sample->create(name => '__TEST__SAMPLE__'),
    processing_profile => Genome::ProcessingProfile::Tester->create(name => '__TEST__PP__'),
);
ok($m, 'create model') or die;
my $library = Genome::Library->create(name => $m->subject->name.'-testlibs', sample => $m->subject);
my @id;
for my $i (1..2) {
    push @id, Genome::InstrumentData::Solexa->create(
        library => $library,
        flow_cell_id => 1,
        subset_name => 1,
        run_name => 1,
        total_bases_read => 1,
        read_length => 1,
        clusters => 1,
    );
}
is(@id, 2, 'create 2 inst data');
ok($m->add_instrument_data($id[0]), 'add inst data to model');

#< Successes >#
# list assigned
my $lister = Genome::Model::Command::InstrumentData::List->create(model_id => $m->id);
ok($lister, 'Created the lister');
ok($lister->execute, 'Show assigned instrument data');
# list compatible
$lister = Genome::Model::Command::InstrumentData::List->create(
    model_id => $m->id,
    compatible => 1,
);
ok($lister, 'Created the lister for compatible inst data');
ok($lister->execute, 'Show compatable instrument data');

#< Fails >#
# no model id
$lister = Genome::Model::Command::InstrumentData::List->create();
ok($lister, 'Created the lister w/o model id');
ok(!$lister->execute, 'Execution fails as expected');
# assigned and compatible
$lister = Genome::Model::Command::InstrumentData::List->create(
    model_id => $m->id,
    assigned => 1,
    compatible => 1,
);
ok($lister, 'Created the lister trying to list assigned AND compatible inst data');
ok(!$lister->execute, 'Execution fails as expected');
