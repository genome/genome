#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above 'Genome';

use Test::More;

use_ok('Genome::Model::Build::Error') or die;

class WFE { # work flow error
    has => [
        name => { is => 'Text', },
        path_name => { is => 'Text', },
        dispatch_identifier => { is => 'Text', },
        _build_path_string => { is => 'Text', },
        error => { is => 'Text', },
        start_time => { is => 'Text', },
        end_time => { is => 'Text', },
    ],
};

class TestEvent {
    is => 'Genome::Model::Event',
};
sub TestEvent::error_log_file { return 'log_dir/error.err'; }
my $event = TestEvent->__define__();
ok($event, 'create event');

my $error = Genome::Model::Build::Error->create(
    build_event_id => 1,
    stage_event_id => 1,
    stage => 'assemble',
    step_event => $event,
    step => 'trim-and-screen',
    error => 'This totally died.',
);
ok($error, 'create error');
is($error->error_log, 'log_dir/error.err', 'Log file');
ok($error->error_wrapped, 'Wrapped error');

my @wf_errors = _create_wf_errors();
is(scalar(@wf_errors), 2, 'Created 2 wf errors');
my @errors = Genome::Model::Build::Error->create_from_workflow_errors(@wf_errors);
is(scalar(@errors), 1, 'Converted 1 wf errors to build errors');

done_testing();
exit;

sub _create_wf_errors  {
    my @wf_errors;
    push @wf_errors, WFE->__define__(
        # BUILD_EVEVNT_ID STAGE
        name => '97901036 assemble',
        # BUILD_EVEVNT_ID STAGE
        path_name => '97901036 all stages',
        _build_path_string => '97901036 all stages',
        # LSF_JOB_ID maybe undef
        dispatch_identifier => undef,
        # ERROR_STRING
        error => <<EOS,
Execution halted due to unresolvable dependencies or crashed children.  Status and incomplete inputs:
input connector <591875> (done)
output connector <591876> (new)
  result
verify-instrument-data 97901037 <591877> (done)
prepare-instrument-data 97901038 <591878> (done)
trim-and-screen 97901039 <591879> (crashed)
assemble 97901040 <591880> (new)
  prior_result
classify 97901041 <591881> (new)
  prior_result
orient 97901042 <591882> (new)
  prior_result
collate 97901043 <591883> (new)
  prior_result
clean-up 97901044 <591884> (new)
  prior_result
reports 97901045 <591885> (new)
  prior_result
merge results <591886> (new)
  result_1
EOS
        ,
        start_time => UR::Context->current->now,
        end_time => UR::Context->current->now,
    );

    push @wf_errors, WFE->__define__(
        # STEP EVENT_ID  
        name => 'trim-and-screen 97901040',
        # BUILD_EVEVNT_ID STAGE/STEP EVENT_ID  
        path_name => '97901036 all stages/97901036 assemble/trim-and-screen 97901040',
        _build_path_string=> '97901036 all stages/97901036 assemble/trim-and-screen 97901040',
        # LSF_JOB_ID maybe undef
        dispatch_identifier => 1000002,
        # ERROR_STRING
        error => 'A really long error message to see if wrapping the text of this error looks good in the report that is generated for users to see why their build failed and what happened to cause it to fail.',
        start_time => UR::Context->current->now,
        end_time => UR::Context->current->now,
    );

    return @wf_errors;
}

