#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above 'Genome';

require File::Compare;
use Test::More;

use_ok('Genome::Model::Build::MetagenomicComposition16s::ProcessSangerInstrumentData') or die;

use_ok('Genome::Model::Build::MetagenomicComposition16s::TestBuildFactory') or die;
my ($build, $example_build) = Genome::Model::Build::MetagenomicComposition16s::TestBuildFactory->build_with_example_build_for_sanger;
ok($build && $example_build, 'Got build and example_build');

my $cmd = Genome::Model::Build::MetagenomicComposition16s::ProcessSangerInstrumentData->create(input_build => $build);
my $process_ok = $cmd->execute;
ok($process_ok, 'Process sanger instrument data');

my @example_amplicon_sets = $example_build->amplicon_sets;
is(@example_amplicon_sets, 1, 'Got 1 amplicon set from example build');
my @amplicon_sets = $build->amplicon_sets;
is(@amplicon_sets, @example_amplicon_sets, 'Got 1 amplicon set from build');

print $amplicon_sets[0]->processed_fasta_file."\n";
ok(-s $amplicon_sets[0]->processed_fasta_file, 'processed fasta file');
is(
    File::Compare::compare($amplicon_sets[0]->processed_fasta_file, $example_amplicon_sets[0]->processed_fasta_file), 
    0,
    'processed amplicon fasta file matches',
);
ok(-s $amplicon_sets[0]->processed_qual_file, 'processed qual file');
is(
    File::Compare::compare($amplicon_sets[0]->processed_qual_file, $example_amplicon_sets[0]->processed_qual_file), 
    0,
    'processed amplicon qual file matches',
);

my @amplicon_names;
my $amplicons = $amplicon_sets[0]->amplicon_iterator;
while ( my $amplicon = $amplicons->() ) {
    push @amplicon_names, $amplicon->{name};
}
is_deeply(
    \@amplicon_names,
    [qw/ HMPB-aad13a05 HMPB-aad13e12 HMPB-aad16a01 HMPB-aad16c10 /],
    'Got 4 amplicons',
);

ok(-s $build->fasta_dir.'/'.$build->file_base_name.'.reads.raw.fasta', 'Created the raw reads fasta file');
# Time diffs prevent comparing files. Maybe update the desc for these reads
#is(File::Compare::compare($build->raw_reads_fasta_file, $example_build->raw_reads_fasta_file), 0, 'raw reads fasta file matches');
ok(-s $build->fasta_dir.'/'.$build->file_base_name.'.reads.raw.fasta.qual', 'Created the raw reads qual file');

ok(-s $build->fasta_dir.'/'.$build->file_base_name.'.reads.processed.fasta', 'Created the processed reads fasta file');
# Time diffs prevent comparing files. Maybe update the desc for these reads
#is(File::Compare::compare($build->processed_reads_fasta_file, $example_build->processed_reads_fasta_file), 0, 'processed reads fasta file matches');
ok(-s $build->fasta_dir.'/'.$build->file_base_name.'.reads.processed.fasta.qual', 'Created the processed reads qual file');

# metrics
is($build->amplicons_attempted, 5, 'amplicons attempted is 5');
is($build->amplicons_processed, 4, 'amplicons processed is 4');
is($build->amplicons_processed_success, '0.80', 'amplicons processed success is 0.80');
is($build->reads_attempted, 30, 'reads attempted is 30');
is($build->reads_processed, 17, 'reads processed is 17');
is($build->reads_processed_success, '0.57', 'reads processed success is 0.57');

#print $build->data_directory."\n";<STDIN>;
done_testing();
exit;

