#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above 'Genome';

use Data::Dumper 'Dumper';
require File::Compare;
require File::Temp;
use Test::More;

use_ok('Genome::Model::Build::MetagenomicComposition16s::454') or die;

# sample, lib
my $sample = Genome::Sample->create(
    id => -1234,
    name => 'H_GV-933124G-S.MOCK',
);
ok($sample, 'create sample');

my $library = Genome::Library->create(
    id => -12345,
    name => $sample->name.'-testlibs',
    sample_id => $sample->id,
);
ok($library, 'create library');

# inst data
my $inst_data_dir = $ENV{GENOME_TEST_INPUTS} . '/Genome-Model/MetagenomicComposition16s454/inst_data';
ok(-d $inst_data_dir, 'inst data dir') or die;
my $instrument_data = Genome::InstrumentData::454->create(
    id => -7777,
    region_number => 3,
    total_reads => 20,
    run_name => 'R_2010_01_09_11_08_12_FLX08080418_Administrator_100737113',
    library => $library,
    sequencing_platform => '454',
);
ok($instrument_data, 'create inst data');
no warnings qw/ once redefine /;
*Genome::InstrumentData::454::dump_fasta_file = sub{ return $inst_data_dir.'/-7777.fasta'; };
*Genome::InstrumentData::454::dump_sanger_fastq_files = sub{ return $inst_data_dir.'/-7777.fastq'; };
use warnings;
ok(-s $instrument_data->dump_fasta_file, 'fasta file');
ok(-s $instrument_data->dump_sanger_fastq_files, 'fastq file');

# pp MC16s-WashU-454-RDP2.1
my $pp = Genome::ProcessingProfile->get(2742461);
ok($pp, 'got 454 pp') or die;

# model
my $model = Genome::Model::MetagenomicComposition16s->create(
    processing_profile => $pp,
    subject_name => $sample->name,
    subject_type => 'sample_name'
);
ok($model, 'MC16s 454 model') or die;
ok($model->add_instrument_data($instrument_data), 'add inst data to model');

my $tmpdir = File::Temp::tempdir(CLEANUP => 1);
my $build = Genome::Model::Build::MetagenomicComposition16s->create(
    id => -1199,
    model => $model,
    data_directory => $tmpdir,
);
isa_ok($build, 'Genome::Model::Build::MetagenomicComposition16s::454');
ok($build->get_or_create_data_directory, 'resolved data dir');

my $example_build = Genome::Model::Build->create(
    model=> $model,
    id => -2288,
    data_directory => $ENV{GENOME_TEST_INPUTS} . '/Genome-Model/MetagenomicComposition16s454/build_v4.2chimeras', # start w/ 2 chimeras
);
ok($example_build, 'example build') or die;

# calculated kb
is($build->calculate_estimated_kb_usage, 1024, 'estimated kb usage');

# dirs
ok($build->create_subdirectories, 'created subdirectories');

my $classification_dir = $build->classification_dir;
is($classification_dir, $build->data_directory.'/classification', 'classification_dir');
ok(-d $classification_dir, 'classification_dir exists');

my $fasta_dir = $build->fasta_dir;
is($fasta_dir, $build->data_directory.'/fasta', 'fasta_dir');
ok(-d $fasta_dir, 'fasta_dir exists');

# files
my $file_base = $build->file_base_name;
is($file_base, $build->subject_name, 'file base');

#< AMPLICON SETS >#
my @standards = (
    { name => 'V1_V3', amplicons => [qw/ FZ0V7MM01A01AQ FZ0V7MM01A01O4 FZ0V7MM01A02JE FZ0V7MM01A02T9 FZ0V7MM01A0327 /] },
    { name => 'V3_V5', amplicons => [qw/ FZ0V7MM01A00L3 FZ0V7MM01A00YG FZ0V7MM01A02O2 FZ0V7MM01A03HG /] },
    { name => 'V6_V9', amplicons => [qw/ FZ0V7MM01A004O FZ0V7MM01A00FU FZ0V7MM01A00G0 FZ0V7MM01A00IA FZ0V7MM01A00XH /] },
    { name => 'none', amplicons => [qw/ FZ0V7MM01A00CR FZ0V7MM01A023X FZ0V7MM01A032H FZ0V7MM01A0QNB FZ0V7MM01A0R82 /] },
);
my @set_names = $build->amplicon_set_names;
is_deeply(\@set_names, [ sort grep { $_ ne 'none' } map { $_->{name} } @standards ], 'amplicon set names');
my @amplicon_sets = $build->amplicon_sets;
is(@amplicon_sets, 3, 'got 3 amplicon sets');
my @example_amplicon_sets = $example_build->amplicon_sets;
is(@example_amplicon_sets, 3, 'got 3 example amplicon sets');

#< PREPARE >#
ok($build->prepare_instrument_data, 'prepare instrument data');
for ( my $i = 0; $i < @amplicon_sets; $i++ ) { 
    my $set_name = $amplicon_sets[$i]->name;
    my $example_set_name = $example_amplicon_sets[$i]->name;
    is($set_name, $example_set_name, 'set name mathces');
    my $fasta_file = $amplicon_sets[$i]->processed_fasta_file;
    ok(-s $fasta_file, "fasta file for $set_name was created");
    my $example_fasta_file = $example_amplicon_sets[$i]->processed_fasta_file;
    ok(-s $example_fasta_file, "example fasta file for $set_name");
    is(File::Compare::compare($fasta_file, $example_fasta_file), 0, "fasta file matches example");
    #print join(' ', 'gvimdiff', $fasta_file, $example_fasta_file, "\n");<STDIN>;
}

# metrics
is($build->amplicons_attempted, 20, 'amplicons attempted is 20');
is($build->amplicons_processed, 14, 'amplicons processed is 14');
is($build->amplicons_processed_success, '0.70', 'amplicons processed success is 0.70');
is($build->reads_attempted, 20, 'reads attempted is 20');
is($build->reads_processed, 14, 'reads processed is 14');
is($build->reads_processed_success, '0.70', 'reads processed success is 0.70');

#< DETECT CHIMERAS ># this is not deterministic!
ok($build->detect_and_remove_chimeras, 'detect and remove chimeras');
my $amplicons_chimeric = 2;
if ( $build->amplicons_chimeric == 3 ) { # switch to 3 chimeras if necessary
    $example_build->data_directory($ENV{GENOME_TEST_INPUTS} . '/Genome-Model/MetagenomicComposition16s454/build_v4.3chimeras');
    # Get the sets again to pickup the new data_directory otherwise the old data_directory is used.
    @example_amplicon_sets = $example_build->amplicon_sets;
    $amplicons_chimeric = 3;
}
for ( my $i = 0; $i < @amplicon_sets; $i++ ) { 
    ok(-s $amplicon_sets[$i]->chimera_file, 'chimera file');

    my $chimera_free_fasta_file = $amplicon_sets[$i]->chimera_free_fasta_file;
    my $example_chimera_free_fasta_file = $example_amplicon_sets[$i]->chimera_free_fasta_file;
    my $chimera_free_fasta_file_diff = qx(diff -u $example_chimera_free_fasta_file $chimera_free_fasta_file);
    ok(!$chimera_free_fasta_file_diff, 'no differences between chimera_free_fasta_files') || print $chimera_free_fasta_file_diff;

    my $chimera_free_qual_file = $amplicon_sets[$i]->chimera_free_qual_file;
    my $example_chimera_free_qual_file = $example_amplicon_sets[$i]->chimera_free_qual_file;
    my $chimera_free_qual_file_diff = qx(diff -u $example_chimera_free_qual_file $chimera_free_qual_file);
    ok(!$chimera_free_qual_file_diff, 'no differences between chimera_free_qual_files') || print $chimera_free_qual_file_diff;
}
# metrics
is($build->amplicons_processed, 14, 'amplicons processed is 14');
is($build->amplicons_chimeric, $amplicons_chimeric, 'amplicons chimeric is '.$amplicons_chimeric);
my $chimeric_pct = sprintf('%.2f', $build->amplicons_chimeric / $build->amplicons_processed);
is($build->amplicons_chimeric_percent, $chimeric_pct, 'amplicons chimeric percent is '.$chimeric_pct);

#< CLASSIFY >#
ok($build->classify_amplicons, 'classify amplicons');
is($build->amplicons_classified, $build->amplicons_processed, 'amplicons classified matches processed: '.$build->amplicons_processed);
is($build->amplicons_classified_success, '1.00', 'amplicons classified success is 1.00');
is($build->amplicons_classification_error, 0, 'amplicons classified error is 0');

#< ORIENT >#
ok($build->orient_amplicons, 'orient amplicons');

#< AMPLICON SETS >#
for ( my $i = 0; $i < @amplicon_sets; $i++ ) { 
    # name
    my $set_name = $amplicon_sets[$i]->name;
    is($set_name, $example_amplicon_sets[$i]->{name}, 'amplicon set name');
    # fastas
    for my $type (qw/ processed oriented /) {
        my $method = $type.'_fasta_file';
        my $fasta_file = $amplicon_sets[$i]->$method;
        is(
            $fasta_file,
            $fasta_dir.'/'.$file_base.'.'.$set_name.'.'.$type.'.fasta',
            "$type fasta file for set name: $set_name"
        );
        ok(-s $fasta_file, "$type fasta file name exists for set $set_name")
        #is(File::Compare::compare($fasta_file, $EXAMPLE), 0, "$type fasta file name exists for set $set_name");
    }
    # classification
    my $classification_file = $amplicon_sets[$i]->classification_file;
    is(
        $classification_file,
        $classification_dir.'/'.$file_base.'.'.$set_name.'.'.$build->classifier,
        "classification file name for set name: $set_name"
    );
    my $diff_ok = Genome::Model::Build::MetagenomicComposition16s->diff_rdp(
        $example_amplicon_sets[$i]->classification_file,
        $classification_file,
    );
    ok($diff_ok, 'diff rdp files');
    # amplicons
    while ( my $amplicon = $amplicon_sets[$i]->next_amplicon ) {
        my $example_amplicon = $example_amplicon_sets[$i]->next_amplicon;
        is($amplicon->{name}, $example_amplicon->{name}, 'matches example amplicon');
        ok($amplicon->{classification}, $amplicon->{name}.' has a classification');
        is_deeply([@{$amplicon->{classification}}[0..3]], [@{$example_amplicon->{classification}}[0..3]], 'classification matches');
    }
}

#< QC Model Email >#
ok($build->perform_post_success_actions, 'perform post success actions');
is($build->status_message, 'Model is not for QC. Not sending confirmation email', 'correct status message');
my $model_name = $model->name;
$model->name('ebelter-mc16s-qc');
ok($build->perform_post_success_actions, 'perform post success actions');
is($build->status_message, 'Sent email to Erica (esodergren) and Kathie (kmihindu)', 'correct status message');
$model->name($model_name);

#< Diff >#
for my $type (qw/ in out /) {
    my %custom_diff = $build->matching_regex_for_custom_diff($build->fasta_dir.'/metrics.processed.'.$type.'.txt');
    is_deeply([ keys %custom_diff ], [qw/ metrics /], "custom diff for $type metrics");
    ok(
        Genome::Model::Build::MetagenomicComposition16s->diff_metrics(
            $example_build->fasta_dir.'/metrics.processed.'.$type.'.txt',
            $build->fasta_dir.'/metrics.processed.'.$type.'.txt',
        ),
        "diff $type metrics",
    );
}

#print $build->data_directory."\n";<STDIN>;
done_testing();
