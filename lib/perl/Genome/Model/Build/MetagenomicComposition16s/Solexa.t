#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above 'Genome';

use Test::More;
require File::Compare;

if (Genome::Config->arch_os ne 'x86_64') {
    plan skip_all => 'requires 64-bit machine';
}

use_ok('Genome::Model::Build::MetagenomicComposition16s::Solexa') or die;

# sample, lib
my $sample = Genome::Sample->create(
    id => -1234,
    name => 'H_GV-933124G-S.MOCK',
);
ok($sample, 'create sample');

my $library = Genome::Library->create(
    id => -12345,
    name => $sample->name.'-testlibs',
    sample_id => $sample->id,
);
ok($library, 'create library');

# inst data
my $inst_data_dir = $ENV{GENOME_TEST_INPUTS} . '/Genome-Model/MetagenomicComposition16sSolexa/inst_data';
ok(-d $inst_data_dir, 'inst data dir') or die;

my $instrument_data = Genome::InstrumentData::Solexa->create(
    id => -7777,
    library => $library,
    flow_cell_id => '12345',
    lane => '1',
    median_insert_size => '22',
    run_name => '110101_TEST',
    subset_name => 4,
    run_type => 'Paired',
#   gerald_directory => $ENV{GENOME_TEST_INPUTS} . '/Genome-InstrumentData-Align-Maq/test_sample_name', #needed?
    bam_path => $ENV{GENOME_TEST_INPUTS} . '/Genome-InstrumentData-AlignmentResult-Bwa/input.bam',
);
ok($instrument_data, 'create inst data');

# pp
my $pp = Genome::ProcessingProfile->__define__(
    type_name => 'metagenomic composition 16s',
    name => 'MC16s TEST',
    sequencing_platform => 'solexa',
    amplicon_processor => 'filter by-min-length --length 50',
    sequencing_center => 'gsc',
    classifier => 'rdp2-2',
    classifier_params => '-training-set 6 -format hmp_fix_ranks -version 2x2',
);
ok($pp, 'got solexa pp') or die;

# model
my $model = Genome::Model::MetagenomicComposition16s->create(
    processing_profile => $pp,
    subject_name => $sample->name,
    subject_type => 'sample_name'
);
ok($model, 'MC16s solexa model') or die;
ok($model->add_instrument_data($instrument_data), 'add inst data to model');

my $example_build = Genome::Model::Build->create( 
    data_directory => $ENV{GENOME_TEST_INPUTS} . '/Genome-Model/MetagenomicComposition16sSolexa/build',
    model=> $model,
    id => -2288
);
ok($example_build, 'example build') or die;
ok($example_build->get_or_create_data_directory, 'resolved data dir');

my $tmpdir = File::Temp::tempdir(CLEANUP => 1);
my $build = Genome::Model::Build::MetagenomicComposition16s->create(
    id => -1199,
    model => $model,
    data_directory => $tmpdir,
);
isa_ok($build, 'Genome::Model::Build::MetagenomicComposition16s::Solexa');

ok($build->get_or_create_data_directory, 'resolved data dir');
ok($build->create_subdirectories, 'created subdirectories');

# calculated kb
is($build->calculate_estimated_kb_usage, 500_000, 'estimated kb usage'); 

# dirs
my $classification_dir = $build->classification_dir;
is($classification_dir, $build->data_directory.'/classification', 'classification_dir');
ok(-d $classification_dir, 'classification_dir exists');

my $fasta_dir = $build->fasta_dir;
is($fasta_dir, $build->data_directory.'/fasta', 'fasta_dir');
ok(-d $fasta_dir, 'fasta_dir exists');

# files
my $file_base = $build->file_base_name;
is($file_base, $build->subject_name, 'file base');

#< PREPARE >#
ok($build->prepare_instrument_data, 'prepare instrument data');
my @amplicon_sets = $build->amplicon_sets;
is(@amplicon_sets, 1, 'amplicon sets');
my $amplicon_set = $amplicon_sets[0];
my ($example_amplicon_set) = $example_build->amplicon_sets;
ok($example_amplicon_set, 'example amplicon set');

ok(-s $amplicon_set->processed_fasta_file, 'processed fasta file');
is(
    File::Compare::compare($amplicon_set->processed_fasta_file, $example_amplicon_set->processed_fasta_file), 
    0,
    'processed fasta file matches',
);

# metrics
is($build->amplicons_attempted, 600, 'amplicons attempted is 600');
is($build->amplicons_processed, 600, 'amplicons processed is 600');
is($build->amplicons_processed_success, '1.00', 'amplicons processed success is 1.00');
is($build->reads_attempted, 600, 'reads attempted is 600');
is($build->reads_processed, 600, 'reads processed is 600');
is($build->reads_processed_success, '1.00', 'reads processed success is 1.00');

#< CLASSIFY >#
ok($build->classify_amplicons, 'classify amplicons');
is($build->amplicons_classified, 432, 'amplicons classified');
is($build->amplicons_classification_error, 168, 'amplicons classified error');
is($build->amplicons_classified_success, '0.72', 'amplicons classified success');
my $diff_ok = Genome::Model::Build::MetagenomicComposition16s->diff_rdp(
    $amplicon_set->classification_file,
    $example_amplicon_set->classification_file,
);
ok($diff_ok, 'diff rdp files');

#< ORIENT >#
ok($build->orient_amplicons, 'orient amplicons');
ok(-s $amplicon_set->oriented_fasta_file, 'oriented fasta file');
is(
    File::Compare::compare($amplicon_set->oriented_fasta_file, $example_amplicon_set->oriented_fasta_file), 
    0,
    'oriented fasta file matches',
);

#print $build->data_directory;<STDIN>;
done_testing();
exit;

