#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;

use_ok("Genome::Model::Build::SomaticVariation::CalcCovgResult");

my $data_dir = $ENV{GENOME_TEST_INPUTS} . '/Genome-Model-Build-SomaticVariation-CalcCovgResult';

my $base_dir = $data_dir."/v1";

my $ref_seq = $base_dir."/ref.fa";

my $build = &setup_somatic_variation_build;

my %calc_covg_params = (
    somatic_variation_build => $build,
    reference_sequence => $ref_seq,,
    roi_file => $base_dir."/roi.bed",
    normal_min_depth => 6,
    tumor_min_depth => 8,
    min_mapq => 20,
    test_name => "testing",
);

$DB::single = 1;
my $calc_covg_result = Genome::Model::Build::SomaticVariation::CalcCovgResult->get_or_create(%calc_covg_params);
isa_ok($calc_covg_result, 'Genome::Model::Build::SomaticVariation::CalcCovgResult', 'successful run');

my $file_name = $calc_covg_result->output_file;
my $output_file = $calc_covg_result->output_dir."/".$file_name;

my $expected_out = $base_dir."/expected.out";

my $diff = Genome::Sys->diff_file_vs_file($output_file, $expected_out);
ok(!$diff, 'returned file matches expected file')
    or diag("diff:\n" . $diff);

done_testing;

sub setup_somatic_variation_build {
    use Genome::Test::Factory::Model::SomaticVariation;

    my $sv_build = Genome::Test::Factory::Model::SomaticVariation->setup_somatic_variation_build();

    $sv_build->tumor_build->subject->extraction_label('test_individual1');
    $sv_build->normal_build->subject->extraction_label('test_individual2');

    # why are these normal/tumor backwards?
    Genome::Sys->create_directory($sv_build->tumor_build->data_directory . "/alignments");
    Genome::Sys->create_directory($sv_build->normal_build->data_directory . "/alignments");
    Genome::Sys->create_symlink("$base_dir/normal.bam", $sv_build->tumor_build->data_directory . "/alignments/normal_merged_rmdup.bam");
    Genome::Sys->create_symlink("$base_dir/normal.bam.bai", $sv_build->tumor_build->data_directory . "/alignments/normal_merged_rmdup.bam.bai");
    Genome::Sys->create_symlink("$base_dir/tumor.bam", $sv_build->normal_build->data_directory . "/alignments/tumor_merged_rmdup.bam");
    Genome::Sys->create_symlink("$base_dir/tumor.bam.bai", $sv_build->normal_build->data_directory . "/alignments/tumor_merged_rmdup.bam.bai");

    return $sv_build;
}
