#!/usr/bin/env genome-perl

use strict;
use warnings;

use above 'Genome';
use Sys::Hostname;
require File::Temp;
use Test::More;

Genome::Report::Email->silent();

# use
use_ok('Genome::Model::Build::Command::Start') or die;

delete $ENV{NO_LSF};

# ur dummy ids
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
ok($ENV{UR_USE_DUMMY_AUTOGENERATED_IDS}, 'Use dummy ids');
$ENV{UR_DBI_NO_COMMIT} = 1;
ok($ENV{UR_DBI_NO_COMMIT}, 'No commit');

my $s = Genome::Sample->create(name => 'TEST-' . __FILE__ . "-$$");
ok($s, "made a test sample");

my $p = Genome::ProcessingProfile::TestPipeline->create(
    name => "test " . __FILE__ . " on host ".hostname." process $$",
    some_command_name => 'ls',
);
ok($p, "made a test processing profile");

my $m = Genome::Model::TestPipeline->create(
    processing_profile_id => $p->id,
    subject_class_name => ref($s),
    subject_id => $s->id,
);
ok($m, "made a test model");
my $model_id = $m->id;

# tmpdir
my $tmpdir = File::Temp::tempdir(CLEANUP => 1);
ok(-d $tmpdir, 'Created temp dir');

# ok
my $rv = eval { 
    my $model_start = Genome::Model::Build::Command::Start->create(
        models => [$m],
        data_directory => $tmpdir,
    );
    return $model_start->execute;
};
ok(!$@, "the command did not crash");
is($rv, 1, "command believes it succeeded");

done_testing();


#$HeadURL$
#$Id$
