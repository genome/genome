#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use above 'Genome';

use Test::More tests => 6;

use_ok('Genome::Model::Tools::Varscan::ProcessValidation');

my $test_data_dir = $ENV{GENOME_TEST_INPUTS} . '/Genome-Model-Tools-Varscan-ProcessValidation';
my $variants_file = join('/', $test_data_dir, 'variant_list.snp');
my $validation_file = join('/', $test_data_dir, 'varscan.snp');
my $filtered_validation_file = join('/', $test_data_dir, 'varscan.snp.Somatic.strandfilter');

my $expected_result_dir = join('/', $test_data_dir, '1');
my $expected_output_file = join('/', $expected_result_dir, 'targeted_snvs.validation');

my $tmpdir = File::Temp::tempdir('Varscan-ProcessValidationXXXXX', DIR => "$ENV{GENOME_TEST_TEMP}/", CLEANUP => 1);
my $output_file = join('/', $tmpdir, 'targeted_snvs.validation');
my $output_plot = join('/', $tmpdir, 'targeted_snvs.validation.plot');

my $validation_command = Genome::Model::Tools::Varscan::ProcessValidation->create(
    variants_file => $variants_file,
    validation_file => $validation_file,
    filtered_validation_file => $filtered_validation_file,
    output_file => $output_file,
    output_plot => 1,
);
isa_ok($validation_command, 'Genome::Model::Tools::Varscan::ProcessValidation', 'created validation command');
ok($validation_command->execute(), 'executed validation command');

my $output_diff = Genome::Sys->diff_file_vs_file($expected_output_file, $output_file);
ok(!$output_diff, 'output file matches expected result')
    or diag("diff:\n" . $output_diff);

ok(-s $validation_command->output_plot_file, 'created a plot');
ok(-s $validation_command->output_somatic_plot_file, 'created a somatic plot');
