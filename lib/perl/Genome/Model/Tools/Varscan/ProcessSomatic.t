#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use strict;
use warnings;

use above 'Genome';

use Test::More tests => 12;

use_ok('Genome::Model::Tools::Varscan::ProcessSomatic');


my $test_data_dir = $ENV{GENOME_TEST_INPUTS} . '/Genome-Model-Tools-Varscan-ProcessSomatic';

my $snp_file = join('/', $test_data_dir, 'varscan.snp');

my $expected_result_dir = join('/', $test_data_dir, '1');
my $expected_basename = join('/', $expected_result_dir, 'varscan.snp');

my %expected_files = (
    output_somatic => $expected_basename . '.Somatic',
    output_somatic_hc => $expected_basename . '.Somatic.hc',
    output_somatic_lc => $expected_basename . '.Somatic.lc',
    output_loh => $expected_basename . '.LOH',
    output_loh_hc => $expected_basename . '.LOH.hc',
    output_loh_lc => $expected_basename . '.LOH.lc',
    output_germline => $expected_basename . '.Germline',
    output_germline_hc => $expected_basename . '.Germline.hc',
    output_germline_lc => $expected_basename . '.Germline.lc',
);

my $tmpdir = File::Temp::tempdir('Varscan-ProcessSomaticXXXXX', DIR => "$ENV{GENOME_TEST_TEMP}/", CLEANUP => 1);

my $output_basename = join('/', $tmpdir, 'varscan.snp');

my $varscan_command = Genome::Model::Tools::Varscan::ProcessSomatic->create(
    status_file => $snp_file,
    output_basename => $output_basename,

    p_value_for_hc => 0.07,
    max_normal_freq => 5,
    min_tumor_freq => 10,
);
isa_ok($varscan_command, 'Genome::Model::Tools::Varscan::ProcessSomatic', 'created varscan command');
ok($varscan_command->execute(), 'executed varscan command');

for my $file (keys %expected_files) {
    my $diff = Genome::Sys->diff_file_vs_file($varscan_command->$file, $expected_files{$file});

    ok(!$diff, $file . ' matches expected result')
        or diag("diff:\n" . $diff);
}
