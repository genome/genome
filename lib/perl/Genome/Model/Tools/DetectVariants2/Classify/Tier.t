#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use above 'Genome';
use Test::More tests => 3;

use_ok('Genome::Model::Tools::DetectVariants2::Classify::Tier');

my $prior_dir = Genome::Sys->create_temp_directory;
my $hq_file = $prior_dir . '/snvs.hq.novel.v2.bed';
my $lq_file = $prior_dir . '/snvs.hq.previously_detected.v2.bed';

Genome::Sys->write_file($hq_file, <<EOFILE
1	16906391	16906392	C/Y	28	39
1	16906836	16906837	C/S	59	20
1	13105026	13105027	C/G	6	3
1	16907421	16907422	G/K	24	17
EOFILE
);

Genome::Sys->write_file($lq_file, <<EOFILE
1	16906440	16906441	C/Y	56	28
1	16906854	16906855	G/R	0	25
1	13105035	13105036	C/T	6	3
1	16906344	16906345	A/G	108	52
EOFILE
);

my $pd_result = Genome::Model::Tools::DetectVariants2::Classify::PreviouslyDiscovered->__define__(
    output_dir => $prior_dir,
    variant_type => 'snv',
);
$pd_result->lookup_hash($pd_result->calculate_lookup_hash());
$DB::single = 1;
my $tier_result = Genome::Model::Tools::DetectVariants2::Classify::Tier->create(
    variant_type => 'snv',
    prior_result_id => $pd_result->id,
    annotation_build_id => 102550711, #54_36p_v2
    classifier_version => 3,
);
isa_ok($tier_result, 'Genome::Model::Tools::DetectVariants2::Classify::Tier', 'created result');
my $result_dir = $tier_result->output_dir;

my $expected_dir = Genome::Sys->create_temp_directory;
Genome::Sys->write_file("$expected_dir/snvs.hq.novel.tier1.v2.bed", "1	16906391	16906392	C/Y	28	39\n");
Genome::Sys->write_file("$expected_dir/snvs.hq.novel.tier2.v2.bed", "1	16906836	16906837	C/S	59	20\n");
Genome::Sys->write_file("$expected_dir/snvs.hq.novel.tier3.v2.bed", "1	13105026	13105027	C/G	6	3\n");
Genome::Sys->write_file("$expected_dir/snvs.hq.novel.tier4.v2.bed", "1	16907421	16907422	G/K	24	17\n");

Genome::Sys->write_file("$expected_dir/snvs.hq.previously_detected.tier1.v2.bed", "1	16906440	16906441	C/Y	56	28\n");
Genome::Sys->write_file("$expected_dir/snvs.hq.previously_detected.tier2.v2.bed", "1	16906854	16906855	G/R	0	25\n");
Genome::Sys->write_file("$expected_dir/snvs.hq.previously_detected.tier3.v2.bed", "1	13105035	13105036	C/T	6	3\n");
Genome::Sys->write_file("$expected_dir/snvs.hq.previously_detected.tier4.v2.bed", "1	16906344	16906345	A/G	108	52\n");

my $diff = `diff -rq $expected_dir $result_dir`;
ok(!$diff, 'output matches expected output')
    or diag($diff);
