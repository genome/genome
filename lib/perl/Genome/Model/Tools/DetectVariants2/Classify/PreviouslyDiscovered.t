#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use Test::More tests => 7;

use above 'Genome';

use_ok('Genome::Model::Tools::DetectVariants2::Classify::PreviouslyDiscovered') or die('cannot run tests without module');

my $temp_dir = Genome::Sys->create_temp_directory;

my $somatic_file = Genome::Sys->write_file($temp_dir . '/snvs.somatic.v2.bed', <<EOFILE
1	518	519	C/G	99	33
1	2612084	2612085	T/G	99	51
1	3496117	3496118	T/C	99	150
1	11276954	11276955	T/C	99	111
1	14106899	14106900	C/T	99	171
1	15997729	15997730	G/A	99	138
1	20086912	20086913	A/G	99	141
2	6068	6069	T/W	99	9
2	526786	526787	G/A	99	20
2	714815	714816	A/W	99	17
2	812822	812823	C/Y	99	79
2	849547	849548	G/A	99	48
2	853465	853466	T/C	99	35
EOFILE
);

my $loh_result = Genome::Model::Tools::DetectVariants2::Classify::Loh->__define__(
    output_dir => $temp_dir,
);

#real data
my $dbsnp_build = Genome::Model::Build::ImportedVariationList->get(
    'model.name' => 'dbSNP-NCBI-human-build36',
    version => 130,
);

my $result = Genome::Model::Tools::DetectVariants2::Classify::PreviouslyDiscovered->create(
    prior_result_id => $loh_result->id,
    previously_discovered_result_id => $dbsnp_build->snv_result->id,
    variant_type => 'snv',
    classifier_version => 1,
    skip_filtering => 0,
);
isa_ok($result, 'Genome::Model::Tools::DetectVariants2::Classify::PreviouslyDiscovered', 'created result');

my $pd_file = $result->path('snvs.hq.previously_detected.v2.bed');
my $expected_pd_file = $temp_dir . '/previous.expected.bed';
Genome::Sys->write_file($expected_pd_file, <<EOFILE
1	518	519	C/G	99	33
EOFILE
);
ok(!Genome::Sys->diff_file_vs_file($expected_pd_file, $pd_file), 'previously discovered file is as expected')
    or diag("diff:\n" . Genome::Sys->diff_file_vs_file($expected_pd_file, $pd_file));

my $expected_novel_file = ($temp_dir . '/novel.expected.bed');
Genome::Sys->write_file($expected_novel_file, <<EOFILE
1	2612084	2612085	T/G	99	51
1	3496117	3496118	T/C	99	150
1	11276954	11276955	T/C	99	111
1	14106899	14106900	C/T	99	171
1	15997729	15997730	G/A	99	138
1	20086912	20086913	A/G	99	141
2	6068	6069	T/W	99	9
2	526786	526787	G/A	99	20
2	714815	714816	A/W	99	17
2	812822	812823	C/Y	99	79
2	849547	849548	G/A	99	48
2	853465	853466	T/C	99	35
EOFILE
);

my $novel_file = $result->path('snvs.hq.novel.v2.bed');
ok(!Genome::Sys->diff_file_vs_file($expected_novel_file, $novel_file), 'novel file is as expected')
    or diag("diff:\n" . Genome::Sys->diff_file_vs_file($expected_novel_file, $novel_file));

my $result2 = Genome::Model::Tools::DetectVariants2::Classify::PreviouslyDiscovered->create(
    prior_result_id => $loh_result->id,
    previously_discovered_result_id => $dbsnp_build->snv_result->id,
    variant_type => 'snv',
    classifier_version => 1,
    skip_filtering => 1,
);
isa_ok($result2, 'Genome::Model::Tools::DetectVariants2::Classify::PreviouslyDiscovered', 'created result');

my $pd_file2 = $result2->path('snvs.hq.previously_detected.v2.bed');
my $expected_pd_file2 = $temp_dir . '/previous.expected2.bed';
Genome::Sys->write_file($expected_pd_file2, <<EOFILE
EOFILE
);
ok(!Genome::Sys->diff_file_vs_file($expected_pd_file2, $pd_file2), 'previously discovered file is as expected')
    or diag("diff:\n" . Genome::Sys->diff_file_vs_file($expected_pd_file2, $pd_file2));

my $expected_novel_file2 = ($temp_dir . '/novel.expected2.bed');
Genome::Sys->write_file($expected_novel_file2, <<EOFILE
1	518	519	C/G	99	33
1	2612084	2612085	T/G	99	51
1	3496117	3496118	T/C	99	150
1	11276954	11276955	T/C	99	111
1	14106899	14106900	C/T	99	171
1	15997729	15997730	G/A	99	138
1	20086912	20086913	A/G	99	141
2	6068	6069	T/W	99	9
2	526786	526787	G/A	99	20
2	714815	714816	A/W	99	17
2	812822	812823	C/Y	99	79
2	849547	849548	G/A	99	48
2	853465	853466	T/C	99	35
EOFILE
);

my $novel_file2 = $result2->path('snvs.hq.novel.v2.bed');
ok(!Genome::Sys->diff_file_vs_file($expected_novel_file2, $novel_file2), 'novel file is as expected')
    or diag("diff:\n" . Genome::Sys->diff_file_vs_file($expected_novel_file2, $novel_file2));

