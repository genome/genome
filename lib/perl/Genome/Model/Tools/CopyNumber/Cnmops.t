#!/usr/bin/env perl

use above 'Genome';
use Test::More;
use strict;
use warnings;

BEGIN {
  $ENV{UR_DBI_NO_COMMIT} = 1;
  $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
  $ENV{NO_LSF} = 1;
};

my $pkg = 'Genome::Model::Tools::CopyNumber::Cnmops';
use_ok($pkg);

#Define the test where expected results are stored
my $expected_output_dir = $ENV{"GENOME_TEST_INPUTS"} . "Genome-Model-Tools-CopyNumber-Cnmops/2014-04-03/";
ok(-e $expected_output_dir, "Found test dir: $expected_output_dir") or die;

my $temp_dir = Genome::Sys->create_temp_directory();
ok($temp_dir, "created temp directory: $temp_dir") or die;

my $run_cnmops;
subtest "execute" => sub {
  my $clinseq_model = Genome::Model->get(name => 'apipe-test-clinseq-wer');
  $run_cnmops = $pkg->create(outdir=>$temp_dir, clinseq_model=>$clinseq_model, test=>1);
  $run_cnmops->queue_status_messages(1);
  $run_cnmops->execute();
  #Dump the output to a log file
  my @output1 = $run_cnmops->status_messages();
  my $log_file = $temp_dir . "/RunCnmops.log.txt";
  my $log = IO::File->new(">$log_file");
  $log->print(join("\n", @output1));
  $log->close();
  ok(-e $log_file, "Wrote message file from cnmops to a log file: $log_file");

  #Perform a diff between the stored results and those generated by this test
  my @diff = `diff -r -x '*.log.txt' -x '*.pdf' -x '*.Robject' $expected_output_dir $temp_dir`;
  ok(@diff == 0, "Found only expected number of differences between expected results and test results")
  or do {
    diag("expected: $expected_output_dir\nactual: $temp_dir\n");
    diag("differences are:");
    diag(@diff);
    my $diff_line_count = scalar(@diff);
    print "\n\nFound $diff_line_count differing lines\n\n";
  };
  Genome::Sys->shellcmd(cmd => "rm -fr /tmp/last-run-gmt-copynumber-cnmops/");
  Genome::Sys->shellcmd(cmd => "mv $temp_dir /tmp/last-run-gmt-copynumber-cnmops/");
  Genome::Sys->status_message("stored last results in /tmp/last-run-gmt-copynumber-cnmops/");
};

done_testing();
