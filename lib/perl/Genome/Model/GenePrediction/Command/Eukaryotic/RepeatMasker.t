use strict;
use warnings;

use above 'Genome';

use Bio::Seq;
use Bio::SeqIO;
use File::Temp 'tempdir';
use File::Basename;
use Test::More;

if (Genome::Config->arch_os ne 'x86_64') {
    plan skip_all => 'requires 64-bit machine';
}

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use_ok('Genome::Model::GenePrediction::Command::Eukaryotic::RepeatMasker');

my $test_data_dir = $ENV{GENOME_TEST_INPUTS} . '/Genome-Model-GenePrediction-Eukaryotic/';
ok(-d $test_data_dir, "test data directory exists at $test_data_dir");

my $fasta_file = $test_data_dir . "repeat_masker_input.fasta";
ok(-e $fasta_file, "test fasta file found at $fasta_file");

my $repeat_library = '/gsc/var/lib/repeat/Trichinella_spiralis-3.7.1_070320.rep';
ok(-e $repeat_library, "found repeat library at $repeat_library");

my $temp_dir = tempdir(
    "$ENV{GENOME_TEST_TEMP}/Genome-Model-GenePrediction-Eukaryotic-RepeatMasker-XXXXXX",
    CLEANUP => 1,
    UNLINK => 1,
);
my $masked_fasta = File::Temp->new(
    TEMPLATE => 'repeat_masker_masked_fasta_XXXXXX',
    DIR => $temp_dir,
    UNLINK => 1,
    CLEANUP => 1,
);
my $ace_file = File::Temp->new(
    TEMPLATE => 'repeat_masker_ace_file_XXXXXX',
    DIR => $temp_dir,
    UNLINK => 1,
    CLEANUP => 1,
);
my $gff_file = File::Temp->new(
    TEMPLATE => 'repeat_masker_gff_file_XXXXXX',
    DIR => $temp_dir,
    UNLINK => 1,
    CLEANUP => 1,
);

my $command = Genome::Model::GenePrediction::Command::Eukaryotic::RepeatMasker->create(
    fasta_file => $fasta_file, 
    repeat_library => $repeat_library,
    masked_fasta => $masked_fasta->filename,
    make_ace => 1,
    ace_file_location => $ace_file->filename,
    temp_working_directory => $temp_dir,
    make_gff => 1,
    gff_file_location => $gff_file->filename,
);

isa_ok($command, 'Genome::Model::GenePrediction::Command::Eukaryotic::RepeatMasker');
ok($command->execute(), 'execute');
ok(-s $command->masked_fasta, 'data written to masked fasta');
ok(-s $command->ace_file_location, 'data written to ace file');

use Bio::SeqIO;
my $input_fasta = Bio::SeqIO->new(
    -file => $fasta_file,
    -format => 'Fasta',
);
my $output_fasta = Bio::SeqIO->new(
    -file => $masked_fasta,
    -format => 'Fasta',
);

my %input_seqs;
while (my $input_seq = $input_fasta->next_seq()) {
    $input_seqs{$input_seq->id}++;
}

my %output_seqs;
while (my $output_seq = $output_fasta->next_seq()) {
    $output_seqs{$output_seq->id}++;
}

for my $input_seq_name (sort keys %input_seqs) {
    my $input_count = delete $input_seqs{$input_seq_name};
    my $output_count = delete $output_seqs{$input_seq_name};

    ok(defined $output_count, "input sequence $input_seq_name appears in output");
    next if not defined $output_count;

    ok($output_count == 1, "$input_seq_name only appears once in output ($output_count)");
}

done_testing();

