#!/usr/bin/env genome-perl
use strict;
use warnings;

$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = "1";
$ENV{UR_DBI_NO_COMMIT} = "1";

use above "Genome";
use Test::More;

if (Genome::Config->arch_os ne 'x86_64') {
    plan skip_all => 'requires 64-bit machine';
}
else {
    plan tests => 17;
}


my $l = Genome::Library->get(2868598818);
ok($l, 'got a library');

my $s = $l->sample;
ok($s, 'got a sample via library');

my $i = Genome::InstrumentData::Command::Import::Bam->create(
    target_region       => 'none',
    sample              => $s->name,  
    library             => $l->name,
    import_source_name  => 'Broad',
    original_data_path  => $ENV{GENOME_TEST_INPUTS} . '/Genome-InstrumentData--Command-Import-Bam/test.bam',
    description         => 'bwa file',
    species_name        => 'human',
    reference_sequence_build_id => 103107618,
);

ok($i, "Import Bam Command created ok");
ok($i->execute,"Test Bam is imported ok");

note "instrument data id is ". $i->import_instrument_data_id."\n";

my $i_d = Genome::InstrumentData::Imported->get($i->import_instrument_data_id);
is($i_d->sample_id, $s->id, 'sample id is correct');
is($i_d->library_id, $l->id, 'library id is correct');
is($i_d->sequencing_platform,'solexa','platform is correct');
is($i_d->user_name, Genome::Sys->username, "user name is correct");
ok($i_d->import_date, "date is set");
is($i_d->reference_sequence_build_id, 103107618, "Reference sequence properly retreived, " . $i_d->reference_sequence_build_id. ".");
is($i_d->base_count, 274209200, "Base count is correct");
is($i_d->read_count, 2742092, "Read count is correct");
is($i_d->fragment_count, 5484184, "Fragment count is correct");
is($i_d->read_length, 50 , "Read length set correctly");
is($i_d->is_paired_end, 1, "Paired end status correct");
is($i_d->target_region_set_name, 'none', "Target region set name");

my $ok;
eval { $ok = UR::Context->_sync_databases(); };
ok($ok, "saves to the database!");
