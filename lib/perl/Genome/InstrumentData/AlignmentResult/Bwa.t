#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above 'Genome';
use Genome::Test::Factory::SoftwareResult::User;

use File::Path;
use Test::More;

my $arch_os = Genome::Sys->arch_os;
if ($arch_os =~ /x86_64/) {
    plan tests => 19;
} else {
    plan skip_all => 'Must run on a 64 bit machine';
}

use_ok('Genome::InstrumentData::AlignmentResult::Bwa') or die;
use_ok('Genome::InstrumentData::Solexa');

# Inst data
my $instrument_data = Genome::InstrumentData::Solexa->create(
    id => -123456,
    library => Genome::Library->create(
        name => 'test_sample_name-lib1',
        sample => Genome::Sample->create(name => 'test_sample_name'),
    ),
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 10,
    rev_clusters => 10,
    flow_cell_id => '12345',
    lane => '1',
    old_median_insert_size => '22',
    run_name => '110101_TEST',
    subset_name => 4,
    run_type => 'Paired',
    bam_path => Genome::Config::get('test_inputs') . '/Genome-InstrumentData-Align-Bwa/input_rg.bam',
     # expected outputs are here, too
);
ok($instrument_data, 'create instrument data: '.$instrument_data->id);
ok($instrument_data->is_paired_end, 'instrument data is paired end');

# Result parameters
my %result_params = (
    instrument_data_id => $instrument_data->id,
    reference_build => Genome::Model::ImportedReferenceSequence->get(name => 'TEST-human')->build_by_version('1'),
    samtools_version => Genome::Model::Tools::Sam->default_samtools_version,
    picard_version => Genome::Model::Tools::Picard->default_picard_version,
    aligner_version => '0.5.9',
    aligner_name => 'bwa',
);

my $result_users = Genome::Test::Factory::SoftwareResult::User->setup_user_hash(
    reference_sequence_build => $result_params{reference_build},
);

# ALIGN!
my $alignment = Genome::InstrumentData::AlignmentResult->create(
    %result_params,
    _user_data_for_nested_results => $result_users
);
ok($alignment, "created alignment");
isa_ok($alignment, 'Genome::InstrumentData::AlignmentResult::Bwa');
my $bam_path = $alignment->output_dir."/all_sequences.bam";
ok(-s $bam_path, "created a bam");
my $generated_bam_md5 = Genome::Sys->md5sum($bam_path);
is($generated_bam_md5, 'b3e57087223378c0a2c235c5cc782623', "MD5 of bam matches");

my @users = Genome::SoftwareResult::User->get(user => $alignment, label => 'intermediate result');
ok(!@users, 'alignment is not using any intermediate results');

my @iar = Genome::InstrumentData::IntermediateAlignmentResult::Bwa->get(instrument_data_id => $instrument_data->id);
ok(!@iar, 'no intermediate alignment results still exist');

# RECREATE FAIL
my $recreate = Genome::InstrumentData::AlignmentResult->create(
    %result_params,
    _user_data_for_nested_results => $result_users,
);
ok(!$recreate, "Did not recreate the alignment result");
like(Genome::InstrumentData::AlignmentResult::Bwa->error_message, qr/already have one/, "correct error");

# GET WITH LOCK OK
my $get_with_lock = Genome::InstrumentData::AlignmentResult->get_with_lock(
    %result_params,
    users => $result_users
);
ok($get_with_lock, 'Re-get with lock');
is($get_with_lock, $alignment, 'Got the same alignment');

# Clear tmp dir
for ( glob( Genome::Sys->base_temp_directory."/*") ) {
    File::Path::rmtree($_);
}

# ALIGN BY READ GROUP - not sure why this is tested here
$result_params{instrument_data_segment_id} = 'Z';
$result_params{instrument_data_segment_type} = 'read_group';
$alignment = Genome::InstrumentData::AlignmentResult->create(
    %result_params,
    _user_data_for_nested_results => $result_users,
);
ok($alignment, "created alignment");
isa_ok($alignment, 'Genome::InstrumentData::AlignmentResult::Bwa');
$bam_path = $alignment->output_dir."/all_sequences.bam";
ok(-s $bam_path, "created a bam");
$generated_bam_md5 = Genome::Sys->md5sum($bam_path);
is($generated_bam_md5, '5871907cc3b3a49295f5bfb49f20915f', "MD5 of bam matches");
@users = Genome::SoftwareResult::User->get(user => $alignment, label => 'intermediate result');
ok(!@users, 'alignment is not using any intermediate results');

done_testing();
