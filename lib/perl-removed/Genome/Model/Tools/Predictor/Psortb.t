#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;

use_ok('Genome::Model::Tools::Predictor::Psortb') or die;

my $test_data_dir = $ENV{GENOME_TEST_INPUTS} . '/Genome-Model-Tools-Predictor';
ok(-d $test_data_dir, "test data dir exists at $test_data_dir") or die;

my $test_fasta = join('/', $test_data_dir, 'medium.fasta');
ok(-e $test_fasta, "test fasta file exists at $test_fasta") or die;

my $temp_output_dir = Genome::Sys->create_temp_directory();
ok($temp_output_dir and -d $temp_output_dir, "created temp output directory at $temp_output_dir") or die;

my $expected_dump_output = join('/', $test_data_dir, 'psortb.medium_fasta.dump.expected');
ok(-e $expected_dump_output, "expected dump output exists at $expected_dump_output") or die;

my $command = Genome::Model::Tools::Predictor::Psortb->create(
    output_directory => $temp_output_dir,
    input_fasta_file => $test_fasta,
    gram_stain => 'negative',
    version => '',
    parameters => '',
    dump_predictions_to_file => 1,
);
ok($command, 'made command object for psortb');

ok($command->execute, 'successfully executed psortb');
ok(-e $command->raw_output_path, "raw output file exists at expected locadtion " . $command->raw_output_path);
ok(-e $command->dump_output_path, "dump file exists at expected location " . $command->dump_output_path);
ok(-e $command->ace_file_path, "ace file generated at " . $command->ace_file_path);

my $dump_diff = Genome::Sys->diff_file_vs_file($command->dump_output_path, $expected_dump_output);
ok(!$dump_diff, "no differences found between expected dump file $expected_dump_output " . 
    "and generated dump file " . $command->dump_output_path);

done_testing();
